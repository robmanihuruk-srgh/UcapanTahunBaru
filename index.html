<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>‚ú® Template Gereja ‚Äì Natal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Template Ucapan Natal Khusus Gereja ‚Äì Siap Dibagikan & Dijual." />
  <meta name="theme-color" content="#0a1538" />

  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  
  <style>
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,sans-serif;color:#fff;background:#000;min-height:100vh;overflow-y:auto}
    canvas{position:fixed;inset:0;z-index:0;pointer-events:none}
    .container{position:relative;z-index:1;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .card{width:100%;max-width:860px;border-radius:36px;background:linear-gradient(180deg,rgba(255,255,255,.18),rgba(255,255,255,.05));backdrop-filter:blur(30px);box-shadow:0 80px 200px rgba(0,0,0,.95);overflow:hidden;position:relative}
    .watermark{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;opacity:.08;font-size:clamp(28px,6vw,64px);font-weight:700;letter-spacing:4px;transform:rotate(-18deg);text-transform:uppercase}
    .photo{width:100%;max-width:360px;margin:auto;aspect-ratio:4/5;border-radius:26px;overflow:hidden}
    .photo img{width:100%;height:100%;object-fit:cover}
    .content{text-align:center;padding:34px}
    h1{font-family:'Playfair Display',serif;font-size:clamp(34px,6vw,60px);animation:glow 3s ease-in-out infinite alternate}
    @keyframes glow{from{text-shadow:0 0 10px rgba(255,216,138,.4)}to{text-shadow:0 0 35px rgba(255,216,138,1)}}
    @keyframes finishGlow{0%{text-shadow:0 0 0 rgba(255,216,138,0)}100%{text-shadow:0 0 45px rgba(255,216,138,1),0 0 90px rgba(255,216,138,.8)}}
    h1 span{color:#ffd88a;text-shadow:0 0 28px #ffd88a}
    .editor input{padding:12px 18px;border-radius:16px;border:none;width:80%;max-width:360px;font-family:Inter,sans-serif;font-size:16px;margin-top:20px;}
    .share{position:fixed;top:16px;right:16px;z-index:9;display:flex;gap:8px}
    .btn{padding:12px 20px;border-radius:22px;background:rgba(255,255,255,.25);border:1px solid rgba(255,255,255,.45);color:#fff;cursor:pointer;font-family:Inter,sans-serif;font-size:14px;transition:all 0.3s ease;}
    .btn:hover{background:rgba(255,255,255,.35);transform:translateY(-2px);}
    .locked .editor,.locked input[type=file]{display:none}
    .qr{margin-top:18px;display:flex;justify-content:center;padding:10px;}
    .qr img{max-width:200px;height:auto;border-radius:10px;background:#fff;padding:10px;}
    .bible-ref{font-style:italic;margin-top:10px;opacity:0.9;font-size:14px;}
    .controls{display:flex;flex-direction:column;gap:10px;align-items:center;margin-top:20px;}
    .file-input-wrapper{position:relative;width:80%;max-width:360px;}
    .file-input-label{display:block;padding:12px 18px;border-radius:16px;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);color:#fff;text-align:center;cursor:pointer;margin-top:10px;transition:all 0.3s ease;}
    .file-input-label:hover{background:rgba(255,255,255,.25);}
    .photo-input{display:none;}
    .instructions{margin-top:30px;padding:15px;background:rgba(255,255,255,.05);border-radius:15px;font-size:14px;line-height:1.5;opacity:0.8;}
    .instructions h3{margin-top:0;color:#ffd88a;}
    .music-controls{display:flex;align-items:center;gap:10px;margin-top:10px;}
    .volume-slider{width:100px;appearance:none;height:6px;border-radius:3px;background:rgba(255,255,255,.3);outline:none;}
    .volume-slider::-webkit-slider-thumb{appearance:none;width:18px;height:18px;border-radius:50%;background:#ffd88a;cursor:pointer;}
    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.8);color:#fff;padding:12px 24px;border-radius:30px;z-index:1000;opacity:0;transition:opacity 0.3s;pointer-events:none;}
    .toast.show{opacity:1;}
  </style>

  <!-- MUSIC SAFE SOURCE (MULTI FALLBACK) -->
  <audio id="bgMusic" preload="none" loop crossorigin="anonymous">
    <source src="https://cdn.pixabay.com/audio/2022/12/14/audio_3f2c1c9b2b.mp3" type="audio/mpeg">
    <source src="https://assets.mixkit.co/music/preview/mixkit-silent-night-287.mp3" type="audio/mpeg">
    <source src="https://assets.mixkit.co/music/preview/mixkit-christmas-is-here-276.mp3" type="audio/mpeg">
  </audio>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>

<canvas id="fire"></canvas>

<div class="share">
  <button class="btn" id="musicBtn">üé∂ Musik</button>
  <button class="btn" id="saveBtn">üñºÔ∏è Simpan</button>
  <button class="btn" id="shareBtn">üì§ Bagikan</button>
</div>

<div class="container" id="app">
  <div class="card" id="capture">
    <div class="watermark" id="watermark">PREMIUM CHURCH TEMPLATE</div>

    <div class="photo">
      <img id="photoPreview" src="https://images.unsplash.com/photo-1544717305-99670f9c28f1?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80" alt="Foto Natal">
    </div>
    
    <div class="file-input-wrapper">
      <label for="photoInput" class="file-input-label">üì∑ Ganti Foto</label>
      <input type="file" id="photoInput" class="photo-input" accept="image/*">
    </div>

    <div class="content">
      <h1>SELAMAT <span>NATAL</span></h1>
      <p id="blessingWrap" style="margin-top:12px;font-size:clamp(14px,2.5vw,18px);opacity:.95;line-height:1.6"><span id="blessing"></span></p>
      <p class="bible-ref">Yesaya 9:5</p>
      
      <div class="controls">
        <input id="nameInput" placeholder="Masukkan Nama Keluarga / Jemaat">
        <div class="music-controls">
          <label for="volumeSlider">üîä Volume:</label>
          <input type="range" id="volumeSlider" class="volume-slider" min="0" max="1" step="0.1" value="0.5">
        </div>
      </div>
      
      <h2 id="nameDisplay" style="margin-top:14px;font-weight:600;letter-spacing:.5px;min-height:30px;"></h2>
      <div class="qr" id="qr"></div>
      
      <div class="instructions">
        <h3>Cara Penggunaan:</h3>
        1. Masukkan nama keluarga/jemaat<br>
        2. Unggah foto jika ingin mengganti<br>
        3. Tekan "Bagikan" untuk membuat kode QR<br>
        4. Tekan "Simpan" untuk mengunduh gambar<br>
        5. Musik dapat diatur dengan tombol Musik
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast">Pesan disalin!</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.4/build/qrcode.min.js"></script>
<script>
// ===== ELEMENTS =====
const c = document.getElementById('fire');
const x = c.getContext('2d');
const blessingEl = document.getElementById('blessing');
const nameInput = document.getElementById('nameInput');
const photoInput = document.getElementById('photoInput');
const photoPreview = document.getElementById('photoPreview');
const qrBox = document.getElementById('qr');
const app = document.getElementById('app');
const nameDisplay = document.getElementById('nameDisplay');
const music = document.getElementById('bgMusic');
const musicBtn = document.getElementById('musicBtn');
const shareBtn = document.getElementById('shareBtn');
const saveBtn = document.getElementById('saveBtn');
const volumeSlider = document.getElementById('volumeSlider');
const toast = document.getElementById('toast');

// ===== TOAST NOTIFICATION =====
function showToast(message) {
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => {
    toast.classList.remove('show');
  }, 2000);
}

// ===== TYPEWRITER EFFECT =====
const blessingText = 'Sebab seorang Anak telah lahir untuk kita, seorang Putra telah diberikan, dan lambang pemerintahan ada di atas bahu-Nya.';
let i = 0;

function typeWriter() {
  if (i <= blessingText.length) {
    blessingEl.textContent = blessingText.slice(0, i++);
    setTimeout(typeWriter, 45);
  } else {
    document.getElementById('blessingWrap').style.animation = 'finishGlow 2.5s ease forwards';
  }
}

// Start typewriter effect
typeWriter();

// ===== FIREWORKS =====
let w, h;
let fireworks = [];
let particles = [];

function resize() {
  w = c.width = window.innerWidth;
  h = c.height = window.innerHeight;
}

resize();
window.addEventListener('resize', resize);

// Create fireworks
function createFirework() {
  const firework = {
    x: Math.random() * w,
    y: h,
    r: Math.random() * 3 + 2,
    vy: Math.random() * -6 - 4,
    color: `hsl(${Math.random() * 30 + 20}, 100%, 60%)`,
    exploded: false
  };
  fireworks.push(firework);
}

// Create particles when firework explodes
function createParticles(x, y, color) {
  for (let i = 0; i < 30; i++) {
    particles.push({
      x: x,
      y: y,
      vx: (Math.random() - 0.5) * 6,
      vy: (Math.random() - 0.5) * 6,
      r: Math.random() * 2 + 1,
      color: color,
      life: 100
    });
  }
}

// Animation loop
function animate() {
  x.clearRect(0, 0, w, h);
  
  // Draw background stars
  x.fillStyle = 'rgba(255, 255, 255, 0.2)';
  for (let i = 0; i < 50; i++) {
    const starX = (i * 37) % w;
    const starY = (i * 19) % h;
    const size = Math.sin(Date.now() / 1000 + i) * 1 + 1;
    x.beginPath();
    x.arc(starX, starY, size, 0, Math.PI * 2);
    x.fill();
  }
  
  // Update and draw fireworks
  fireworks.forEach(firework => {
    firework.y += firework.vy;
    firework.vy += 0.15;
    
    // Draw firework
    x.fillStyle = firework.color;
    x.beginPath();
    x.arc(firework.x, firework.y, firework.r, 0, Math.PI * 2);
    x.fill();
    
    // Explode if at peak
    if (firework.vy >= 0 && !firework.exploded) {
      firework.exploded = true;
      createParticles(firework.x, firework.y, firework.color);
    }
  });
  
  // Update and draw particles
  particles.forEach(particle => {
    particle.x += particle.vx;
    particle.y += particle.vy;
    particle.vy += 0.05;
    particle.life -= 1;
    
    const alpha = particle.life / 100;
    x.fillStyle = `rgba(255, ${Math.random() * 100 + 155}, ${Math.random() * 100 + 155}, ${alpha})`;
    x.beginPath();
    x.arc(particle.x, particle.y, particle.r, 0, Math.PI * 2);
    x.fill();
  });
  
  // Clean up
  fireworks = fireworks.filter(f => f.y > 0 && !f.exploded);
  particles = particles.filter(p => p.life > 0);
  
  requestAnimationFrame(animate);
}

// Start animation
animate();

// Create fireworks at intervals
setInterval(createFirework, 800);

// ===== PHOTO UPLOAD =====
photoInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  
  if (!file.type.match('image.*')) {
    showToast('Hanya file gambar yang diperbolehkan');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(event) {
    photoPreview.src = event.target.result;
    showToast('Foto berhasil diunggah');
  };
  reader.readAsDataURL(file);
});

// ===== NAME DISPLAY =====
nameInput.addEventListener('input', () => {
  const name = nameInput.value.trim();
  nameDisplay.textContent = name || '';
  
  // Update URL parameter without reloading
  const url = new URL(window.location);
  if (name) {
    url.searchParams.set('name', name);
  } else {
    url.searchParams.delete('name');
  }
  window.history.replaceState({}, '', url);
});

// ===== CHECK FOR LOCKED MODE =====
const query = new URLSearchParams(window.location.search);
const lockName = query.get('name');

if (lockName) {
  document.getElementById('watermark').style.display = 'none';
  nameDisplay.textContent = lockName;
  nameInput.value = lockName;
  app.classList.add('locked');
  showToast(`Selamat Natal, ${lockName}!`);
}

// ===== MUSIC CONTROL =====
let musicOn = false;
let userInteracted = false;

// Volume control
volumeSlider.addEventListener('input', () => {
  music.volume = volumeSlider.value;
});

music.addEventListener('error', () => {
  console.error('Music source failed to load');
  musicBtn.textContent = 'üé∂ Error';
  musicBtn.disabled = true;
});

function startMusic() {
  music.volume = volumeSlider.value;
  music.play().then(() => {
    musicOn = true;
    musicBtn.textContent = '‚è∏Ô∏è Musik';
    showToast('Musik dimulai');
  }).catch(err => {
    console.warn('Music blocked:', err);
    showToast('Klik untuk memulai musik');
  });
}

// First interaction unlock
['click', 'touchstart', 'keydown'].forEach(event => {
  document.addEventListener(event, () => {
    if (!userInteracted) {
      userInteracted = true;
      startMusic();
    }
  }, { once: true });
});

musicBtn.addEventListener('click', e => {
  e.stopPropagation();
  if (!musicOn) {
    startMusic();
  } else {
    music.pause();
    musicOn = false;
    musicBtn.textContent = 'üé∂ Musik';
    showToast('Musik dijeda');
  }
});

// ===== SHARE FUNCTIONALITY =====
shareBtn.addEventListener('click', async () => {
  const name = nameInput.value.trim();
  
  if (!name) {
    showToast('Isi nama terlebih dahulu');
    nameInput.focus();
    return;
  }
  
  const url = `${window.location.origin}${window.location.pathname}?name=${encodeURIComponent(name)}`;
  
  // Generate QR Code
  qrBox.innerHTML = '';
  QRCode.toCanvas(qrBox, url, {
    width: 180,
    height: 180,
    colorDark: '#0a1538',
    colorLight: '#ffffff',
    correctLevel: QRCode.CorrectLevel.H
  }, function(error) {
    if (error) {
      console.error(error);
      showToast('Gagal membuat QR Code');
    } else {
      showToast('QR Code dibuat');
    }
  });
  
  // Try Web Share API first
  if (navigator.share) {
    try {
      await navigator.share({
        title: `Selamat Natal dari ${name}`,
        text: 'Kirimkan ucapan Natal khusus ini kepada keluarga dan jemaat.',
        url: url
      });
      showToast('Berhasil dibagikan');
    } catch (err) {
      if (err.name !== 'AbortError') {
        // Fallback to clipboard
        fallbackShare(url);
      }
    }
  } else {
    // Fallback to clipboard
    fallbackShare(url);
  }
});

function fallbackShare(url) {
  navigator.clipboard.writeText(url).then(() => {
    showToast('Link berhasil disalin ke clipboard');
  }).catch(() => {
    // Last resort - show URL in alert
    prompt('Salin link berikut:', url);
    showToast('Link siap disalin');
  });
}

// ===== SAVE IMAGE =====
saveBtn.addEventListener('click', () => {
  const name = nameInput.value.trim();
  const fileName = name ? `natal-${name.replace(/\s+/g, '-').toLowerCase()}.png` : 'selamat-natal.png';
  
  // Show loading
  saveBtn.textContent = 'Menyimpan...';
  saveBtn.disabled = true;
  
  html2canvas(document.getElementById('capture'), {
    scale: 2,
    useCORS: true,
    backgroundColor: null,
    logging: false
  }).then(canvas => {
    const link = document.createElement('a');
    link.download = fileName;
    link.href = canvas.toDataURL('image/png');
    link.click();
    
    saveBtn.textContent = 'üñºÔ∏è Simpan';
    saveBtn.disabled = false;
    showToast('Gambar berhasil disimpan');
  }).catch(err => {
    console.error('Save error:', err);
    saveBtn.textContent = 'üñºÔ∏è Simpan';
    saveBtn.disabled = false;
    showToast('Gagal menyimpan gambar');
  });
});

// ===== ENTER KEY SUPPORT =====
nameInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    shareBtn.click();
  }
});

// ===== INITIALIZATION =====
window.addEventListener('load', () => {
  console.assert(document.getElementById('capture'), 'Capture exists');
  console.assert(typeof QRCode !== 'undefined', 'QRCode loaded');
  console.assert(music instanceof HTMLAudioElement, 'Music element ok');
  
  // Show welcome message
  setTimeout(() => {
    showToast('Selamat datang! Selamat Natal dan Tahun Baru');
  }, 1000);
});
</script>
</body>
</html>
