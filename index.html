<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>‚ú® Template Gereja ‚Äì Natal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Template Ucapan Natal Khusus Gereja ‚Äì Siap Dibagikan & Dijual." />
  <meta name="theme-color" content="#0a1538" />

  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,sans-serif;color:#fff;background:#000;min-height:100vh;overflow-y:auto}
    canvas{position:fixed;inset:0;z-index:0;pointer-events:none}
    .container{position:relative;z-index:1;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .card{width:100%;max-width:860px;border-radius:36px;background:linear-gradient(180deg,rgba(255,255,255,.18),rgba(255,255,255,.05));backdrop-filter:blur(30px);box-shadow:0 80px 200px rgba(0,0,0,.95);overflow:hidden;position:relative}
    .watermark{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;opacity:.08;font-size:clamp(28px,6vw,64px);font-weight:700;letter-spacing:4px;transform:rotate(-18deg);text-transform:uppercase}
    .photo{width:100%;max-width:360px;margin:auto;aspect-ratio:4/5;border-radius:26px;overflow:hidden}
    .photo img{width:100%;height:100%;object-fit:cover}
    .content{text-align:center;padding:34px}
    h1{font-family:'Playfair Display',serif;font-size:clamp(34px,6vw,60px);animation:glow 3s ease-in-out infinite alternate}
    @keyframes glow{from{text-shadow:0 0 10px rgba(255,216,138,.4)}to{text-shadow:0 0 35px rgba(255,216,138,1)}}
    @keyframes finishGlow{0%{text-shadow:0 0 0 rgba(255,216,138,0)}100%{text-shadow:0 0 45px rgba(255,216,138,1),0 0 90px rgba(255,216,138,.8)}}
    h1 span{color:#ffd88a;text-shadow:0 0 28px #ffd88a}
    .editor input{padding:12px 18px;border-radius:16px;border:none;width:80%;max-width:360px;font-family:Inter,sans-serif;font-size:16px;margin-top:20px;}
    .share{position:fixed;top:16px;right:16px;z-index:9;display:flex;gap:8px}
    .btn{padding:12px 20px;border-radius:22px;background:rgba(255,255,255,.25);border:1px solid rgba(255,255,255,.45);color:#fff;cursor:pointer;font-family:Inter,sans-serif;font-size:14px;transition:all 0.3s ease;}
    .btn:hover{background:rgba(255,255,255,.35);transform:translateY(-2px);}
    .btn:disabled{opacity:0.5;cursor:not-allowed;}
    .btn-small{padding:8px 16px;font-size:13px;}
    .locked .editor,.locked input[type=file]{display:none}
    .qr-container{background:#fff;padding:15px;border-radius:12px;margin:20px auto;max-width:200px;display:flex;justify-content:center;}
    .bible-ref{font-style:italic;margin-top:10px;opacity:0.9;font-size:14px;}
    .controls{display:flex;flex-direction:column;gap:10px;align-items:center;margin-top:20px;}
    .file-input-wrapper{position:relative;width:80%;max-width:360px;}
    .file-input-label{display:block;padding:12px 18px;border-radius:16px;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);color:#fff;text-align:center;cursor:pointer;margin-top:10px;transition:all 0.3s ease;}
    .file-input-label:hover{background:rgba(255,255,255,.25);}
    .photo-input{display:none;}
    .instructions{margin-top:30px;padding:15px;background:rgba(255,255,255,.05);border-radius:15px;font-size:14px;line-height:1.5;opacity:0.8;}
    .instructions h3{margin-top:0;color:#ffd88a;}
    .music-controls{display:flex;align-items:center;gap:10px;margin-top:10px;}
    .volume-slider{width:100px;appearance:none;height:6px;border-radius:3px;background:rgba(255,255,255,.3);outline:none;}
    .volume-slider::-webkit-slider-thumb{appearance:none;width:18px;height:18px;border-radius:50%;background:#ffd88a;cursor:pointer;}
    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.8);color:#fff;padding:12px 24px;border-radius:30px;z-index:1000;opacity:0;transition:opacity 0.3s;pointer-events:none;}
    .toast.show{opacity:1;}
    .share-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:1001;display:flex;align-items:center;justify-content:center;opacity:0;visibility:hidden;transition:all 0.3s;padding:20px;}
    .share-modal.show{opacity:1;visibility:visible;}
    .share-modal-content{background:rgba(255,255,255,0.1);backdrop-filter:blur(20px);border-radius:24px;padding:30px;max-width:500px;width:90%;border:1px solid rgba(255,255,255,0.2);}
    .share-modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
    .share-modal-header h3{margin:0;color:#ffd88a;font-size:24px;}
    .close-modal{background:none;border:none;color:#fff;font-size:28px;cursor:pointer;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:background 0.3s;}
    .close-modal:hover{background:rgba(255,255,255,0.1);}
    .share-url-container{background:rgba(255,255,255,0.1);padding:15px;border-radius:12px;margin:20px 0;position:relative;}
    .share-url{word-break:break-all;font-size:14px;color:#ddd;padding-right:40px;}
    .copy-url-btn{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.2);border:none;color:#fff;width:30px;height:30px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.3s;}
    .copy-url-btn:hover{background:rgba(255,255,255,0.3);}
    .share-buttons{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:25px;}
    .share-button{display:flex;align-items:center;justify-content:center;gap:10px;padding:14px;border-radius:16px;border:none;color:#fff;cursor:pointer;font-size:15px;transition:all 0.3s;font-weight:600;}
    .share-button.whatsapp{background:#25D366;}
    .share-button.telegram{background:#0088cc;}
    .share-button.facebook{background:#1877F2;}
    .share-button.twitter{background:#1DA1F2;}
    .share-button:hover{transform:translateY(-3px);filter:brightness(1.1);}
    .qr-placeholder{width:200px;height:200px;background:rgba(255,255,255,0.1);border-radius:12px;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;color:#aaa;}
    .preview-section{margin-bottom:25px;text-align:center;}
    .preview-title{font-size:18px;color:#ffd88a;margin-bottom:15px;}
    .preview-card{background:rgba(255,255,255,0.05);border-radius:16px;padding:20px;margin-top:10px;max-width:300px;margin-left:auto;margin-right:auto;}
    .preview-name{font-size:20px;font-weight:600;color:#ffd88a;margin-top:10px;}
    .loading-spinner{display:none;width:40px;height:40px;border:4px solid rgba(255,255,255,0.3);border-radius:50%;border-top-color:#ffd88a;animation:spin 1s linear infinite;margin:10px auto;}
    @keyframes spin{100%{transform:rotate(360deg);}}
  </style>

  <!-- MUSIC SOURCES (MULTIPLE RELIABLE SOURCES) -->
  <audio id="bgMusic" preload="none" loop crossorigin="anonymous">
    <source src="https://cdn.jsdelivr.net/gh/skymansoure/music/mp3/silent-night.mp3" type="audio/mpeg">
    <source src="https://assets.mixkit.co/music/preview/mixkit-silent-night-287.mp3" type="audio/mpeg">
    <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
  </audio>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>

<canvas id="fire"></canvas>

<div class="share">
  <button class="btn" id="musicBtn">üé∂ Musik</button>
  <button class="btn" id="saveBtn">üñºÔ∏è Simpan</button>
  <button class="btn" id="shareBtn">üì§ Bagikan</button>
</div>

<!-- Share Modal -->
<div class="share-modal" id="shareModal">
  <div class="share-modal-content">
    <div class="share-modal-header">
      <h3><i class="fas fa-share-alt"></i> Bagikan Ucapan Natal</h3>
      <button class="close-modal" id="closeModal">&times;</button>
    </div>
    
    <div class="preview-section">
      <div class="preview-title">Pratinjau</div>
      <div class="preview-card">
        <div>SELAMAT <span style="color:#ffd88a">NATAL</span></div>
        <div class="preview-name" id="previewName">Nama Anda</div>
      </div>
    </div>
    
    <div class="qr-container" id="qrCodeContainer">
      <div class="qr-placeholder" id="qrPlaceholder">
        <i class="fas fa-qrcode fa-3x"></i>
      </div>
    </div>
    
    <div class="share-url-container">
      <div class="share-url" id="shareUrl">Mengenerate link...</div>
      <button class="copy-url-btn" id="copyUrlBtn" title="Salin Link">
        <i class="far fa-copy"></i>
      </button>
    </div>
    
    <div class="loading-spinner" id="loadingSpinner"></div>
    
    <div class="share-buttons">
      <button class="share-button whatsapp" id="whatsappBtn">
        <i class="fab fa-whatsapp"></i> WhatsApp
      </button>
      <button class="share-button telegram" id="telegramBtn">
        <i class="fab fa-telegram"></i> Telegram
      </button>
      <button class="share-button facebook" id="facebookBtn">
        <i class="fab fa-facebook"></i> Facebook
      </button>
      <button class="share-button twitter" id="twitterBtn">
        <i class="fab fa-twitter"></i> Twitter
      </button>
    </div>
    
    <p style="text-align:center;margin-top:20px;font-size:13px;opacity:0.7;">
      Kode QR akan mengarahkan ke halaman ucapan Natal dengan nama yang sudah diisi
    </p>
  </div>
</div>

<div class="container" id="app">
  <div class="card" id="capture">
    <div class="watermark" id="watermark">PREMIUM CHURCH TEMPLATE</div>

    <div class="photo">
      <img id="photoPreview" src="https://images.unsplash.com/photo-1544717305-99670f9c28f1?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80" alt="Foto Natal">
    </div>
    
    <div class="file-input-wrapper">
      <label for="photoInput" class="file-input-label">üì∑ Ganti Foto</label>
      <input type="file" id="photoInput" class="photo-input" accept="image/*">
    </div>

    <div class="content">
      <h1>SELAMAT <span>NATAL</span></h1>
      <p id="blessingWrap" style="margin-top:12px;font-size:clamp(14px,2.5vw,18px);opacity:.95;line-height:1.6"><span id="blessing"></span></p>
      <p class="bible-ref">Yesaya 9:5</p>
      
      <div class="controls">
        <input id="nameInput" placeholder="Masukkan Nama Keluarga / Jemaat">
        <div class="music-controls">
          <label for="volumeSlider">üîä Volume:</label>
          <input type="range" id="volumeSlider" class="volume-slider" min="0" max="1" step="0.1" value="0.5">
        </div>
      </div>
      
      <h2 id="nameDisplay" style="margin-top:14px;font-weight:600;letter-spacing:.5px;min-height:30px;"></h2>
      
      <!-- QR Code akan muncul di sini saat mode locked -->
      <div id="dynamicQR" style="margin-top:20px;"></div>
      
      <div class="instructions">
        <h3>Cara Penggunaan:</h3>
        1. Masukkan nama keluarga/jemaat<br>
        2. Unggah foto jika ingin mengganti<br>
        3. Tekan "Bagikan" untuk membuat kode QR<br>
        4. Tekan "Simpan" untuk mengunduh gambar<br>
        5. Musik dapat diatur dengan tombol Musik
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast">Pesan disalin!</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.4/build/qrcode.min.js"></script>
<script>
// ===== ELEMENTS =====
const c = document.getElementById('fire');
const x = c.getContext('2d');
const blessingEl = document.getElementById('blessing');
const nameInput = document.getElementById('nameInput');
const photoInput = document.getElementById('photoInput');
const photoPreview = document.getElementById('photoPreview');
const app = document.getElementById('app');
const nameDisplay = document.getElementById('nameDisplay');
const music = document.getElementById('bgMusic');
const musicBtn = document.getElementById('musicBtn');
const shareBtn = document.getElementById('shareBtn');
const saveBtn = document.getElementById('saveBtn');
const volumeSlider = document.getElementById('volumeSlider');
const toast = document.getElementById('toast');
const shareModal = document.getElementById('shareModal');
const closeModal = document.getElementById('closeModal');
const qrCodeContainer = document.getElementById('qrCodeContainer');
const qrPlaceholder = document.getElementById('qrPlaceholder');
const shareUrl = document.getElementById('shareUrl');
const copyUrlBtn = document.getElementById('copyUrlBtn');
const whatsappBtn = document.getElementById('whatsappBtn');
const telegramBtn = document.getElementById('telegramBtn');
const facebookBtn = document.getElementById('facebookBtn');
const twitterBtn = document.getElementById('twitterBtn');
const previewName = document.getElementById('previewName');
const loadingSpinner = document.getElementById('loadingSpinner');
const dynamicQR = document.getElementById('dynamicQR');

// ===== VARIABLES =====
let musicInitialized = false;
let currentQRCode = null;
let shareUrlValue = '';

// ===== TOAST NOTIFICATION =====
function showToast(message, duration = 2000) {
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => {
    toast.classList.remove('show');
  }, duration);
}

// ===== TYPEWRITER EFFECT =====
const blessingText = 'Sebab seorang Anak telah lahir untuk kita, seorang Putra telah diberikan, dan lambang pemerintahan ada di atas bahu-Nya.';
let i = 0;

function typeWriter() {
  if (i <= blessingText.length) {
    blessingEl.textContent = blessingText.slice(0, i++);
    setTimeout(typeWriter, 45);
  } else {
    document.getElementById('blessingWrap').style.animation = 'finishGlow 2.5s ease forwards';
  }
}

// Start typewriter effect
typeWriter();

// ===== FIREWORKS =====
let w, h;
let fireworks = [];
let particles = [];

function resize() {
  w = c.width = window.innerWidth;
  h = c.height = window.innerHeight;
}

resize();
window.addEventListener('resize', resize);

// Create fireworks
function createFirework() {
  const firework = {
    x: Math.random() * w,
    y: h,
    r: Math.random() * 3 + 2,
    vy: Math.random() * -6 - 4,
    color: `hsl(${Math.random() * 30 + 20}, 100%, 60%)`,
    exploded: false
  };
  fireworks.push(firework);
}

// Create particles when firework explodes
function createParticles(x, y, color) {
  for (let i = 0; i < 30; i++) {
    particles.push({
      x: x,
      y: y,
      vx: (Math.random() - 0.5) * 6,
      vy: (Math.random() - 0.5) * 6,
      r: Math.random() * 2 + 1,
      color: color,
      life: 100
    });
  }
}

// Animation loop
function animate() {
  x.clearRect(0, 0, w, h);
  
  // Draw background stars
  x.fillStyle = 'rgba(255, 255, 255, 0.2)';
  for (let i = 0; i < 50; i++) {
    const starX = (i * 37) % w;
    const starY = (i * 19) % h;
    const size = Math.sin(Date.now() / 1000 + i) * 1 + 1;
    x.beginPath();
    x.arc(starX, starY, size, 0, Math.PI * 2);
    x.fill();
  }
  
  // Update and draw fireworks
  fireworks.forEach(firework => {
    firework.y += firework.vy;
    firework.vy += 0.15;
    
    // Draw firework
    x.fillStyle = firework.color;
    x.beginPath();
    x.arc(firework.x, firework.y, firework.r, 0, Math.PI * 2);
    x.fill();
    
    // Explode if at peak
    if (firework.vy >= 0 && !firework.exploded) {
      firework.exploded = true;
      createParticles(firework.x, firework.y, firework.color);
    }
  });
  
  // Update and draw particles
  particles.forEach(particle => {
    particle.x += particle.vx;
    particle.y += particle.vy;
    particle.vy += 0.05;
    particle.life -= 1;
    
    const alpha = particle.life / 100;
    x.fillStyle = `rgba(255, ${Math.random() * 100 + 155}, ${Math.random() * 100 + 155}, ${alpha})`;
    x.beginPath();
    x.arc(particle.x, particle.y, particle.r, 0, Math.PI * 2);
    x.fill();
  });
  
  // Clean up
  fireworks = fireworks.filter(f => f.y > 0 && !f.exploded);
  particles = particles.filter(p => p.life > 0);
  
  requestAnimationFrame(animate);
}

// Start animation
animate();

// Create fireworks at intervals
setInterval(createFirework, 800);

// ===== PHOTO UPLOAD =====
photoInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  
  if (!file.type.match('image.*')) {
    showToast('Hanya file gambar yang diperbolehkan');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(event) {
    photoPreview.src = event.target.result;
    showToast('Foto berhasil diunggah');
  };
  reader.readAsDataURL(file);
});

// ===== NAME DISPLAY =====
nameInput.addEventListener('input', () => {
  const name = nameInput.value.trim();
  nameDisplay.textContent = name || '';
  previewName.textContent = name || 'Nama Anda';
});

// ===== CHECK FOR LOCKED MODE =====
const query = new URLSearchParams(window.location.search);
const lockName = query.get('name');

if (lockName) {
  document.getElementById('watermark').style.display = 'none';
  nameDisplay.textContent = lockName;
  nameInput.value = lockName;
  previewName.textContent = lockName;
  app.classList.add('locked');
  showToast(`Selamat Natal, ${lockName}!`);
  
  // Generate QR code automatically in locked mode
  setTimeout(() => generateQRCodeForCard(lockName), 500);
}

// ===== MUSIC CONTROL =====
volumeSlider.addEventListener('input', () => {
  if (music) {
    music.volume = parseFloat(volumeSlider.value);
  }
});

// Music button click handler
musicBtn.addEventListener('click', () => {
  if (music.paused) {
    music.play().then(() => {
      musicBtn.textContent = '‚è∏Ô∏è Musik';
      showToast('Musik dimulai');
    }).catch(error => {
      showToast('Klik halaman dulu untuk mengaktifkan musik');
    });
  } else {
    music.pause();
    musicBtn.textContent = 'üé∂ Musik';
    showToast('Musik dijeda');
  }
});

// Error handling for music
music.addEventListener('error', (e) => {
  console.error('Music error:', e);
  showToast('Sumber musik tidak tersedia', 3000);
  musicBtn.disabled = true;
  musicBtn.textContent = '‚ùå Musik';
});

// Initialize music
music.volume = 0.5;
musicBtn.disabled = false;

// ===== SHARE FUNCTIONALITY - FIXED VERSION =====
function generateShareUrl(name) {
  const baseUrl = window.location.origin + window.location.pathname;
  return `${baseUrl}?name=${encodeURIComponent(name)}`;
}

function generateQRCode(url, container) {
  return new Promise((resolve, reject) => {
    // Clear container
    container.innerHTML = '';
    
    // Create canvas for QR code
    QRCode.toCanvas(container, url, {
      width: 180,
      height: 180,
      colorDark: '#0a1538',
      colorLight: '#ffffff',
      correctLevel: QRCode.CorrectLevel.H
    }, function(error) {
      if (error) {
        reject(error);
      } else {
        // Add styling to canvas
        const canvas = container.querySelector('canvas');
        if (canvas) {
          canvas.style.borderRadius = '10px';
          canvas.style.padding = '5px';
        }
        resolve();
      }
    });
  });
}

function generateQRCodeForCard(name) {
  const url = generateShareUrl(name);
  generateQRCode(url, dynamicQR).then(() => {
    console.log('QR Code generated for card');
  }).catch(error => {
    console.error('Failed to generate QR code for card:', error);
  });
}

// Share button click handler
shareBtn.addEventListener('click', async () => {
  const name = nameInput.value.trim();
  
  if (!name) {
    showToast('Isi nama terlebih dahulu');
    nameInput.focus();
    return;
  }
  
  // Update preview
  previewName.textContent = name;
  
  // Show loading
  loadingSpinner.style.display = 'block';
  shareUrl.textContent = 'Membuat kode QR...';
  qrPlaceholder.innerHTML = '<i class="fas fa-spinner fa-spin fa-3x"></i>';
  
  // Generate share URL
  shareUrlValue = generateShareUrl(name);
  
  try {
    // Generate QR code
    await generateQRCode(shareUrlValue, qrCodeContainer);
    
    // Update URL display
    shareUrl.textContent = shareUrlValue;
    qrPlaceholder.style.display = 'none';
    
    // Setup share buttons
    setupShareButtons(name, shareUrlValue);
    
    // Show modal
    shareModal.classList.add('show');
    
    showToast('Berhasil membuat kode QR!');
  } catch (error) {
    console.error('Failed to generate QR code:', error);
    shareUrl.textContent = 'Gagal membuat QR code';
    qrPlaceholder.innerHTML = '<i class="fas fa-exclamation-triangle fa-3x"></i>';
    showToast('Gagal membuat QR code', 3000);
  } finally {
    loadingSpinner.style.display = 'none';
  }
});

function setupShareButtons(name, url) {
  const message = `Selamat Natal dari ${name}! Kirimkan ucapan Natal khusus melalui link ini: ${url}`;
  const encodedMessage = encodeURIComponent(message);
  const encodedUrl = encodeURIComponent(url);
  
  // WhatsApp
  whatsappBtn.onclick = () => {
    window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
  };
  
  // Telegram
  telegramBtn.onclick = () => {
    window.open(`https://t.me/share/url?url=${encodedUrl}&text=${encodeURIComponent(`Selamat Natal dari ${name}!`)}`, '_blank');
  };
  
  // Facebook
  facebookBtn.onclick = () => {
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}&quote=${encodeURIComponent(`Selamat Natal dari ${name}`)}`, '_blank');
  };
  
  // Twitter
  twitterBtn.onclick = () => {
    window.open(`https://twitter.com/intent/tweet?text=${encodedMessage}`, '_blank');
  };
}

// Copy URL button
copyUrlBtn.addEventListener('click', async () => {
  if (!shareUrlValue) return;
  
  try {
    await navigator.clipboard.writeText(shareUrlValue);
    showToast('Link berhasil disalin!');
    
    // Change icon temporarily
    const icon = copyUrlBtn.querySelector('i');
    icon.className = 'fas fa-check';
    setTimeout(() => {
      icon.className = 'far fa-copy';
    }, 2000);
  } catch (err) {
    // Fallback for older browsers
    const textArea = document.createElement('textarea');
    textArea.value = shareUrlValue;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    showToast('Link berhasil disalin!');
  }
});

// Close modal
closeModal.addEventListener('click', () => {
  shareModal.classList.remove('show');
});

// Close modal when clicking outside
shareModal.addEventListener('click', (e) => {
  if (e.target === shareModal) {
    shareModal.classList.remove('show');
  }
});

// Close modal with Escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && shareModal.classList.contains('show')) {
    shareModal.classList.remove('show');
  }
});

// ===== SAVE IMAGE =====
saveBtn.addEventListener('click', () => {
  const name = nameInput.value.trim();
  const fileName = name ? `natal-${name.replace(/\s+/g, '-').toLowerCase()}.png` : 'selamat-natal.png';
  
  // Hide share modal if open
  shareModal.classList.remove('show');
  
  // Show loading
  const originalText = saveBtn.textContent;
  saveBtn.textContent = '‚è≥ Menyimpan...';
  saveBtn.disabled = true;
  
  // Use html2canvas to capture the card
  html2canvas(document.getElementById('capture'), {
    scale: 2,
    useCORS: true,
    backgroundColor: null,
    logging: false,
    allowTaint: true,
    foreignObjectRendering: true
  }).then(canvas => {
    // Convert canvas to data URL
    const imageData = canvas.toDataURL('image/png');
    
    // Create download link
    const link = document.createElement('a');
    link.href = imageData;
    link.download = fileName;
    
    // Trigger download
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Restore button
    saveBtn.textContent = originalText;
    saveBtn.disabled = false;
    
    showToast('Gambar berhasil disimpan!');
  }).catch(error => {
    console.error('Error saving image:', error);
    saveBtn.textContent = originalText;
    saveBtn.disabled = false;
    showToast('Gagal menyimpan gambar', 3000);
  });
});

// ===== ENTER KEY SUPPORT =====
nameInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    shareBtn.click();
  }
});

// ===== INITIALIZATION =====
window.addEventListener('load', () => {
  console.log('Aplikasi Template Natal dimuat');
  
  // Check for music support
  if (music.canPlayType('audio/mpeg') === '') {
    musicBtn.disabled = true;
    musicBtn.textContent = '‚ùå Musik (Tidak didukung)';
    showToast('Browser tidak mendukung format musik', 3000);
  }
  
  // Show welcome message
  setTimeout(() => {
    showToast('Selamat Natal dan Tahun Baru! üéÑ‚ú®');
  }, 1500);
});

// ===== INTERACTION HANDLER FOR MUSIC =====
// Handle first user interaction for music
document.addEventListener('click', () => {
  if (!musicInitialized) {
    musicInitialized = true;
    music.volume = parseFloat(volumeSlider.value);
  }
}, { once: true });
</script>
</body>
</html>
