<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>‚ú® Template Gereja ‚Äì Tahun Baru 2026</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Template Ucapan Tahun Baru 2026 Khusus Gereja ‚Äì Siap Dibagikan & Dijual." />
  <meta name="theme-color" content="#0a1538" />

  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,sans-serif;color:#fff;background:#000;min-height:100vh;overflow-y:auto}
    canvas{position:fixed;inset:0;z-index:0;pointer-events:none}
    .container{position:relative;z-index:1;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .card{width:100%;max-width:860px;border-radius:36px;background:linear-gradient(180deg,rgba(255,255,255,.18),rgba(255,255,255,.05));backdrop-filter:blur(30px);box-shadow:0 80px 200px rgba(0,0,0,.95);overflow:hidden;position:relative}
    .watermark{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;opacity:.08;font-size:clamp(28px,6vw,64px);font-weight:700;letter-spacing:4px;transform:rotate(-18deg);text-transform:uppercase}
    .photo{width:100%;max-width:360px;margin:auto;aspect-ratio:4/5;border-radius:26px;overflow:hidden;border:2px solid rgba(255,216,138,0.3);}
    .photo img{width:100%;height:100%;object-fit:cover}
    .content{text-align:center;padding:34px}
    h1{font-family:'Playfair Display',serif;font-size:clamp(34px,6vw,60px);animation:glow 3s ease-in-out infinite alternate;margin-bottom:10px;}
    @keyframes glow{from{text-shadow:0 0 10px rgba(255,216,138,.4)}to{text-shadow:0 0 35px rgba(255,216,138,1)}}
    @keyframes finishGlow{0%{text-shadow:0 0 0 rgba(255,216,138,0)}100%{text-shadow:0 0 45px rgba(255,216,138,1),0 0 90px rgba(255,216,138,.8)}}
    h1 span{color:#ffd88a;text-shadow:0 0 28px #ffd88a}
    .year-text{font-size:clamp(20px,3vw,32px);color:#4dabf7;margin-top:-5px;margin-bottom:20px;font-weight:600;letter-spacing:2px;}
    .editor input{padding:12px 18px;border-radius:16px;border:none;width:80%;max-width:360px;font-family:Inter,sans-serif;font-size:16px;margin-top:20px;}
    .share{position:fixed;top:16px;right:16px;z-index:9;display:flex;gap:8px}
    .btn{padding:12px 20px;border-radius:22px;background:rgba(255,255,255,.25);border:1px solid rgba(255,255,255,.45);color:#fff;cursor:pointer;font-family:Inter,sans-serif;font-size:14px;transition:all 0.3s ease;}
    .btn:hover{background:rgba(255,255,255,.35);transform:translateY(-2px);}
    .btn:disabled{opacity:0.5;cursor:not-allowed;}
    .btn-small{padding:8px 16px;font-size:13px;}
    .locked .editor,.locked input[type=file]{display:none}
    .bible-ref{font-style:italic;margin-top:10px;opacity:0.9;font-size:14px;}
    .controls{display:flex;flex-direction:column;gap:10px;align-items:center;margin-top:20px;}
    .file-input-wrapper{position:relative;width:80%;max-width:360px;}
    .file-input-label{display:block;padding:12px 18px;border-radius:16px;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);color:#fff;text-align:center;cursor:pointer;margin-top:10px;transition:all 0.3s ease;}
    .file-input-label:hover{background:rgba(255,255,255,.25);}
    .photo-input{display:none;}
    .instructions{margin-top:30px;padding:15px;background:rgba(255,255,255,.05);border-radius:15px;font-size:14px;line-height:1.5;opacity:0.8;}
    .instructions h3{margin-top:0;color:#ffd88a;}
    .music-controls{display:flex;align-items:center;gap:10px;margin-top:10px;}
    .volume-slider{width:100px;appearance:none;height:6px;border-radius:3px;background:rgba(255,255,255,.3);outline:none;}
    .volume-slider::-webkit-slider-thumb{appearance:none;width:18px;height:18px;border-radius:50%;background:#ffd88a;cursor:pointer;}
    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.8);color:#fff;padding:12px 24px;border-radius:30px;z-index:1000;opacity:0;transition:opacity 0.3s;pointer-events:none;}
    .toast.show{opacity:1;}
    .share-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:1001;display:flex;align-items:center;justify-content:center;opacity:0;visibility:hidden;transition:all 0.3s;padding:20px;}
    .share-modal.show{opacity:1;visibility:visible;}
    .share-modal-content{background:rgba(255,255,255,0.1);backdrop-filter:blur(20px);border-radius:24px;padding:30px;max-width:500px;width:90%;border:1px solid rgba(255,255,255,0.2);}
    .share-modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
    .share-modal-header h3{margin:0;color:#ffd88a;font-size:24px;}
    .close-modal{background:none;border:none;color:#fff;font-size:28px;cursor:pointer;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:background 0.3s;}
    .close-modal:hover{background:rgba(255,255,255,0.1);}
    .share-url-container{background:rgba(255,255,255,0.1);padding:15px;border-radius:12px;margin:20px 0;position:relative;}
    .share-url{word-break:break-all;font-size:14px;color:#ddd;padding-right:40px;}
    .copy-url-btn{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.2);border:none;color:#fff;width:30px;height:30px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.3s;}
    .copy-url-btn:hover{background:rgba(255,255,255,0.3);}
    .share-buttons{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:25px;}
    .share-button{display:flex;align-items:center;justify-content:center;gap:10px;padding:14px;border-radius:16px;border:none;color:#fff;cursor:pointer;font-size:15px;transition:all 0.3s;font-weight:600;}
    .share-button.whatsapp{background:#25D366;}
    .share-button.telegram{background:#0088cc;}
    .share-button.facebook{background:#1877F2;}
    .share-button.twitter{background:#1DA1F2;}
    .share-button:hover{transform:translateY(-3px);filter:brightness(1.1);}
    .qr-code-container{display:flex;justify-content:center;margin:20px 0;}
    .qr-code{width:200px;height:200px;background:#fff;border-radius:12px;padding:15px;display:flex;align-items:center;justify-content:center;}
    .qr-code img{max-width:100%;height:auto;}
    .loading-spinner{display:none;width:40px;height:40px;border:4px solid rgba(255,255,255,0.3);border-radius:50%;border-top-color:#ffd88a;animation:spin 1s linear infinite;margin:10px auto;}
    @keyframes spin{100%{transform:rotate(360deg);}}
    .music-icon{animation:pulse 2s infinite;}
    @keyframes pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.1);}}
    .qr-display{margin-top:20px;padding:15px;background:rgba(255,255,255,0.05);border-radius:12px;}
    .motivation-text{font-size:clamp(15px,2.2vw,19px);line-height:1.7;margin:25px auto;max-width:700px;padding:0 15px;color:#e9ecef;font-style:italic;}
    .verse-ref{font-size:14px;color:#74c0fc;margin-top:8px;text-align:right;}
    .fireworks{font-size:22px;margin-top:15px;letter-spacing:5px;}
    .new-year-effects{display:flex;justify-content:center;gap:10px;margin:15px 0;font-size:24px;}
    .effect-item{animation:bounce 2s infinite;}
    @keyframes bounce{0%,100%{transform:translateY(0);}50%{transform:translateY(-10px);}}
    .theme-greeting{color:#ffd88a;font-size:18px;margin-top:10px;font-weight:600;}
    .countdown{display:flex;justify-content:center;gap:10px;margin:20px 0;}
    .countdown-item{background:rgba(255,255,255,0.1);padding:10px 15px;border-radius:10px;min-width:60px;}
    .countdown-number{font-size:24px;font-weight:700;color:#ffd88a;}
    .countdown-label{font-size:12px;opacity:0.8;}
    .music-guide{position:fixed;bottom:20px;left:20px;background:rgba(0,0,0,0.7);padding:10px 15px;border-radius:10px;font-size:12px;z-index:100;max-width:200px;}
    .music-guide.hidden{opacity:0;visibility:hidden;}
  </style>
</head>
<body>

<canvas id="fire"></canvas>

<!-- Panduan Musik -->
<div class="music-guide" id="musicGuide">
  <strong>üéµ Panduan Musik:</strong><br>
  1. Klik area putih di halaman<br>
  2. Klik tombol Musik untuk mengaktifkan
</div>

<div class="share">
  <button class="btn" id="musicBtn">üîá Musik</button>
  <button class="btn" id="saveBtn">üñºÔ∏è Simpan</button>
  <button class="btn" id="shareBtn">üì§ Bagikan</button>
</div>

<!-- Share Modal -->
<div class="share-modal" id="shareModal">
  <div class="share-modal-content">
    <div class="share-modal-header">
      <h3><i class="fas fa-share-alt"></i> Bagikan Ucapan Tahun Baru</h3>
      <button class="close-modal" id="closeModal">&times;</button>
    </div>
    
    <p>Bagikan ucapan Tahun Baru 2026 ini dengan keluarga dan jemaat:</p>
    
    <div class="qr-code-container">
      <div class="qr-code" id="qrCodeDisplay">
        <div id="qrPlaceholder" style="color:#333;text-align:center;padding:20px;">
          <i class="fas fa-qrcode fa-3x" style="color:#666;margin-bottom:10px;"></i>
          <p style="font-size:14px;margin:0;">Kode QR akan muncul di sini</p>
        </div>
      </div>
    </div>
    
    <div class="share-url-container">
      <div class="share-url" id="shareUrl">Link akan muncul di sini...</div>
      <button class="copy-url-btn" id="copyUrlBtn" title="Salin Link">
        <i class="far fa-copy"></i>
      </button>
    </div>
    
    <div class="loading-spinner" id="loadingSpinner"></div>
    
    <div class="share-buttons">
      <button class="share-button whatsapp" id="whatsappBtn">
        <i class="fab fa-whatsapp"></i> WhatsApp
      </button>
      <button class="share-button telegram" id="telegramBtn">
        <i class="fab fa-telegram"></i> Telegram
      </button>
      <button class="share-button facebook" id="facebookBtn">
        <i class="fab fa-facebook"></i> Facebook
      </button>
      <button class="share-button twitter" id="twitterBtn">
        <i class="fab fa-twitter"></i> Twitter
      </button>
    </div>
    
    <p style="text-align:center;margin-top:20px;font-size:13px;opacity:0.7;">
      Scan kode QR atau salin link untuk berbagi
    </p>
  </div>
</div>

<div class="container" id="app">
  <div class="card" id="capture">
    <div class="watermark" id="watermark">Tahun Baru 2026</div>

    <div class="photo">
      <img id="photoPreview" src="https://images.unsplash.com/photo-1579546929662-711aa81148cf?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80" alt="Tahun Baru 2026">
    </div>
    
    <div class="file-input-wrapper">
      <label for="photoInput" class="file-input-label">üì∑ Ganti Foto</label>
      <input type="file" id="photoInput" class="photo-input" accept="image/*">
    </div>

    <div class="content">
      <h1>SELAMAT <span>TAHUN BARU</span></h1>
      <div class="year-text">2026</div>
      
      <div class="new-year-effects">
        <div class="effect-item">üéâ</div>
        <div class="effect-item" style="animation-delay:0.2s">‚ú®</div>
        <div class="effect-item" style="animation-delay:0.4s">üéá</div>
        <div class="effect-item" style="animation-delay:0.6s">‚≠ê</div>
        <div class="effect-item" style="animation-delay:0.8s">üéä</div>
      </div>
      
      <div class="motivation-text" id="motivationText">
        "Mari kita sambut Tahun 2026 dengan iman yang teguh, harapan yang baru, dan kasih yang semakin dalam. Tuhan yang memulai pekerjaan baik di dalam kita, akan meneruskannya sampai pada akhirnya."
        <div class="verse-ref">Filipi 1:6</div>
      </div>
      
      <div class="theme-greeting">Tahun Baru, Berkat Baru, Harapan Baru!</div>
      
      <div class="countdown" id="countdown">
        <div class="countdown-item">
          <div class="countdown-number" id="days">365</div>
          <div class="countdown-label">Hari</div>
        </div>
        <div class="countdown-item">
          <div class="countdown-number" id="hours">24</div>
          <div class="countdown-label">Jam</div>
        </div>
        <div class="countdown-item">
          <div class="countdown-number" id="minutes">60</div>
          <div class="countdown-label">Menit</div>
        </div>
        <div class="countdown-item">
          <div class="countdown-number" id="seconds">60</div>
          <div class="countdown-label">Detik</div>
        </div>
      </div>
      
      <div class="controls">
        <input id="nameInput" placeholder="Masukkan Nama Keluarga / Jemaat">
        <div class="music-controls">
          <label for="volumeSlider">üîä Volume:</label>
          <input type="range" id="volumeSlider" class="volume-slider" min="0" max="1" step="0.1" value="0.5">
        </div>
      </div>
      
      <h2 id="nameDisplay" style="margin-top:14px;font-weight:600;letter-spacing:.5px;min-height:30px;"></h2>
      
      <!-- QR Code akan muncul di sini saat mode locked -->
      <div id="qrDisplay" class="qr-display" style="display:none;">
        <h3 style="margin-top:0;color:#ffd88a;font-size:16px;">Scan untuk berbagi:</h3>
        <div id="dynamicQR" style="display:flex;justify-content:center;"></div>
      </div>
      
      <div class="instructions">
        <h3>Cara Penggunaan:</h3>
        1. Klik area putih di halaman untuk mengaktifkan musik<br>
        2. Masukkan nama keluarga/jemaat<br>
        3. Unggah foto jika ingin mengganti<br>
        4. Tekan "Bagikan" untuk membuat kode QR<br>
        5. Tekan "Simpan" untuk mengunduh gambar<br>
        6. Tekan "Musik" untuk memutar/mematikan lagu
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast">Pesan disalin!</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
// ===== ELEMENTS =====
const c = document.getElementById('fire');
const x = c.getContext('2d');
const nameInput = document.getElementById('nameInput');
const photoInput = document.getElementById('photoInput');
const photoPreview = document.getElementById('photoPreview');
const app = document.getElementById('app');
const nameDisplay = document.getElementById('nameDisplay');
const musicBtn = document.getElementById('musicBtn');
const shareBtn = document.getElementById('shareBtn');
const saveBtn = document.getElementById('saveBtn');
const volumeSlider = document.getElementById('volumeSlider');
const toast = document.getElementById('toast');
const shareModal = document.getElementById('shareModal');
const closeModal = document.getElementById('closeModal');
const qrCodeDisplay = document.getElementById('qrCodeDisplay');
const shareUrl = document.getElementById('shareUrl');
const copyUrlBtn = document.getElementById('copyUrlBtn');
const whatsappBtn = document.getElementById('whatsappBtn');
const telegramBtn = document.getElementById('telegramBtn');
const facebookBtn = document.getElementById('facebookBtn');
const twitterBtn = document.getElementById('twitterBtn');
const loadingSpinner = document.getElementById('loadingSpinner');
const dynamicQR = document.getElementById('dynamicQR');
const qrDisplay = document.getElementById('qrDisplay');
const daysEl = document.getElementById('days');
const hoursEl = document.getElementById('hours');
const minutesEl = document.getElementById('minutes');
const secondsEl = document.getElementById('seconds');
const motivationText = document.getElementById('motivationText');
const musicGuide = document.getElementById('musicGuide');

// ===== VARIABLES =====
let musicAudio = null;
let musicPlaying = false;
let userInteracted = false;
let shareUrlValue = '';
let currentName = '';

// Motivasi untuk Tahun Baru 2026
const motivations = [
  {
    text: 'Mari kita sambut Tahun 2026 dengan iman yang teguh, harapan yang baru, dan kasih yang semakin dalam. Tuhan yang memulai pekerjaan baik di dalam kita, akan meneruskannya sampai pada akhirnya.',
    verse: "Filipi 1:6"
  },
  {
    text: 'Sebab Aku ini mengetahui rancangan-rancangan apa yang ada pada-Ku mengenai kamu, demikianlah firman TUHAN, yaitu rancangan damai sejahtera dan bukan rancangan kecelakaan, untuk memberikan kepadamu hari depan yang penuh harapan.',
    verse: "Yeremia 29:11"
  },
  {
    text: 'Janganlah hendaknya kamu kuatir tentang apapun juga, tetapi nyatakanlah dalam segala hal keinginanmu kepada Allah dalam doa dan permohonan dengan ucapan syukur. Damai sejahtera Allah, yang melampaui segala akal, akan memelihara hati dan pikiranmu dalam Kristus Yesus.',
    verse: "Filipi 4:6-7"
  },
  {
    text: 'Sebab itu, jika siapa ada di dalam Kristus, ia adalah ciptaan baru: yang lama sudah berlalu, sesungguhnya yang baru sudah datang. Semuanya ini dari Allah.',
    verse: "2 Korintus 5:17-18"
  },
  {
    text: 'Tetapi orang-orang yang menanti-nantikan TUHAN mendapat kekuatan baru: mereka seumpama rajawali yang naik terbang dengan kekuatan sayapnya; mereka berlari dan tidak menjadi lesu, mereka berjalan dan tidak menjadi lelah.',
    verse: "Yesaya 40:31"
  }
];

// ===== TOAST NOTIFICATION =====
function showToast(message, duration = 2000) {
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => {
    toast.classList.remove('show');
  }, duration);
}

// ===== FIREWORKS =====
let w, h;
let fireworks = [];
let particles = [];

function resize() {
  w = c.width = window.innerWidth;
  h = c.height = window.innerHeight;
}

resize();
window.addEventListener('resize', resize);

// Create fireworks
function createFirework() {
  const firework = {
    x: Math.random() * w,
    y: h,
    r: Math.random() * 3 + 2,
    vy: Math.random() * -6 - 4,
    color: `hsl(${Math.random() * 30 + 20}, 100%, 60%)`,
    exploded: false
  };
  fireworks.push(firework);
}

// Create particles when firework explodes
function createParticles(x, y, color) {
  for (let i = 0; i < 30; i++) {
    particles.push({
      x: x,
      y: y,
      vx: (Math.random() - 0.5) * 6,
      vy: (Math.random() - 0.5) * 6,
      r: Math.random() * 2 + 1,
      color: color,
      life: 100
    });
  }
}

// Animation loop
function animate() {
  x.clearRect(0, 0, w, h);
  
  // Draw background stars
  x.fillStyle = 'rgba(255, 255, 255, 0.2)';
  for (let i = 0; i < 50; i++) {
    const starX = (i * 37) % w;
    const starY = (i * 19) % h;
    const size = Math.sin(Date.now() / 1000 + i) * 1 + 1;
    x.beginPath();
    x.arc(starX, starY, size, 0, Math.PI * 2);
    x.fill();
  }
  
  // Update and draw fireworks
  fireworks.forEach(firework => {
    firework.y += firework.vy;
    firework.vy += 0.15;
    
    // Draw firework
    x.fillStyle = firework.color;
    x.beginPath();
    x.arc(firework.x, firework.y, firework.r, 0, Math.PI * 2);
    x.fill();
    
    // Explode if at peak
    if (firework.vy >= 0 && !firework.exploded) {
      firework.exploded = true;
      createParticles(firework.x, firework.y, firework.color);
    }
  });
  
  // Update and draw particles
  particles.forEach(particle => {
    particle.x += particle.vx;
    particle.y += particle.vy;
    particle.vy += 0.05;
    particle.life -= 1;
    
    const alpha = particle.life / 100;
    x.fillStyle = `rgba(255, ${Math.random() * 100 + 155}, ${Math.random() * 100 + 155}, ${alpha})`;
    x.beginPath();
    x.arc(particle.x, particle.y, particle.r, 0, Math.PI * 2);
    x.fill();
  });
  
  // Clean up
  fireworks = fireworks.filter(f => f.y > 0 && !f.exploded);
  particles = particles.filter(p => p.life > 0);
  
  requestAnimationFrame(animate);
}

// Start animation
animate();

// Create fireworks at intervals
setInterval(createFirework, 800);

// ===== PHOTO UPLOAD =====
photoInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  
  if (!file.type.match('image.*')) {
    showToast('Hanya file gambar yang diperbolehkan');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(event) {
    photoPreview.src = event.target.result;
    showToast('Foto berhasil diunggah');
  };
  reader.readAsDataURL(file);
});

// ===== NAME DISPLAY =====
nameInput.addEventListener('input', () => {
  const name = nameInput.value.trim();
  nameDisplay.textContent = name || '';
  currentName = name;
});

// ===== COUNTDOWN TIMER =====
function updateCountdown() {
  const now = new Date();
  const currentYear = now.getFullYear();
  const nextYear = currentYear + 1;
  
  // Set target to January 1 of next year
  const targetDate = new Date(`January 1, ${nextYear} 00:00:00`);
  
  // If we're already in the new year, show days until next year
  const diff = targetDate - now;
  
  const days = Math.floor(diff / (1000 * 60 * 60 * 24));
  const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
  const seconds = Math.floor((diff % (1000 * 60)) / 1000);
  
  daysEl.textContent = days;
  hoursEl.textContent = hours.toString().padStart(2, '0');
  minutesEl.textContent = minutes.toString().padStart(2, '0');
  secondsEl.textContent = seconds.toString().padStart(2, '0');
  
  // If it's already 2026, show celebration mode
  if (currentYear >= 2026) {
    daysEl.textContent = "üéâ";
    hoursEl.textContent = "‚ú®";
    minutesEl.textContent = "2026";
    secondsEl.textContent = "üéä";
    document.querySelector('.countdown-label').style.display = 'none';
  }
}

// Initialize countdown
updateCountdown();
setInterval(updateCountdown, 1000);

// ===== ROTATE MOTIVATION TEXT =====
let currentMotivationIndex = 0;

function rotateMotivation() {
  const motivation = motivations[currentMotivationIndex];
  motivationText.innerHTML = `"${motivation.text}"<div class="verse-ref">${motivation.verse}</div>`;
  
  currentMotivationIndex = (currentMotivationIndex + 1) % motivations.length;
}

// Rotate every 10 seconds
setInterval(rotateMotivation, 10000);

// ===== CHECK FOR LOCKED MODE =====
const query = new URLSearchParams(window.location.search);
const lockName = query.get('name');

if (lockName) {
  document.getElementById('watermark').style.display = 'none';
  nameDisplay.textContent = lockName;
  nameInput.value = lockName;
  currentName = lockName;
  app.classList.add('locked');
  showToast(`Selamat Tahun Baru 2026, ${lockName}!`);
  
  // Generate QR code automatically in locked mode
  setTimeout(() => generateSimpleQRCode(lockName), 1000);
}

// ===== MUSIC CONTROL - IMPROVED VERSION =====
function initMusic() {
  musicAudio = new Audio();
  
  // Start with muted audio (usually allowed by browsers)
  musicAudio.muted = true;
  musicAudio.loop = true;
  musicAudio.volume = parseFloat(volumeSlider.value);
  
  // Multiple music sources for New Year
  const musicSources = [
    'https://cdn.freesound.org/previews/462/462142_5121236-lq.mp3',
    'https://cdn.freesound.org/previews/640/640648_14184230-lq.mp3',
    'https://assets.mixkit.co/music/preview/mixkit-silent-night-287.mp3'
  ];
  
  musicAudio.src = musicSources[0];
  
  // Try to play muted audio
  musicAudio.play().then(() => {
    console.log('Music ready (muted)');
    musicBtn.textContent = 'üîá Musik';
  }).catch(e => {
    console.log('Muted autoplay also blocked');
  });
  
  // Handle source errors
  musicAudio.addEventListener('error', () => {
    console.log('Music source error, trying next...');
    if (musicAudio.src.includes(musicSources[0])) {
      musicAudio.src = musicSources[1];
    } else if (musicAudio.src.includes(musicSources[1])) {
      musicAudio.src = musicSources[2];
    }
  });
}

// Volume control
volumeSlider.addEventListener('input', () => {
  if (musicAudio) {
    musicAudio.volume = parseFloat(volumeSlider.value);
  }
});

// Music button click handler
musicBtn.addEventListener('click', () => {
  if (!musicAudio) {
    initMusic();
  }
  
  if (musicAudio.muted) {
    // Try to unmute and play
    musicAudio.muted = false;
    musicPlaying = true;
    musicBtn.textContent = 'üîä Musik';
    showToast('Musik diaktifkan! üéµ');
    
    // Hide music guide after successful activation
    musicGuide.classList.add('hidden');
  } else {
    // Mute the audio
    musicAudio.muted = true;
    musicPlaying = false;
    musicBtn.textContent = 'üîá Musik';
    showToast('Musik dimatikan');
  }
});

// ===== USER INTERACTION HANDLER =====
function handleFirstInteraction() {
  if (!userInteracted) {
    userInteracted = true;
    console.log('User interacted with page');
    
    // Update music button to show it's ready
    musicBtn.textContent = 'üîá Aktifkan Musik';
    musicBtn.disabled = false;
    
    // Hide the music guide after 3 seconds
    setTimeout(() => {
      musicGuide.classList.add('hidden');
    }, 3000);
    
    // If music was already initialized, try to unmute
    if (musicAudio && musicAudio.muted) {
      musicAudio.muted = false;
      musicAudio.play().then(() => {
        musicPlaying = true;
        musicBtn.textContent = 'üîä Musik';
        showToast('Musik otomatis diaktifkan!');
      }).catch(e => {
        // Keep muted if autoplay still blocked
        musicAudio.muted = true;
        musicBtn.textContent = 'üîá Aktifkan Musik';
      });
    }
  }
}

// Listen for user interactions
['click', 'touchstart', 'keydown'].forEach(event => {
  document.addEventListener(event, handleFirstInteraction, { once: true });
});

// ===== QR CODE GENERATION =====
function generateQRCodeWithAPI(text, containerId) {
  // Use Google Charts API for QR code (simple and reliable)
  const qrUrl = `https://chart.googleapis.com/chart?cht=qr&chs=200x200&chl=${encodeURIComponent(text)}&choe=UTF-8&chld=L|2&chco=0a1538`;
  
  const container = document.getElementById(containerId);
  container.innerHTML = `<img src="${qrUrl}" alt="QR Code" style="max-width:100%;height:auto;border-radius:8px;">`;
  
  return qrUrl;
}

function generateSimpleQRCode(name) {
  const url = `${window.location.origin}${window.location.pathname}?name=${encodeURIComponent(name)}`;
  
  // Show QR container
  qrDisplay.style.display = 'block';
  
  // Generate QR code
  generateQRCodeWithAPI(url, 'dynamicQR');
  
  return url;
}

// ===== SHARE FUNCTIONALITY =====
shareBtn.addEventListener('click', () => {
  const name = nameInput.value.trim();
  
  if (!name) {
    showToast('Isi nama terlebih dahulu');
    nameInput.focus();
    return;
  }
  
  // Show loading
  loadingSpinner.style.display = 'block';
  shareUrl.textContent = 'Membuat kode QR...';
  
  // Generate share URL
  const url = `${window.location.origin}${window.location.pathname}?name=${encodeURIComponent(name)}`;
  shareUrlValue = url;
  
  // Generate QR code using Google Charts API
  const qrUrl = `https://chart.googleapis.com/chart?cht=qr&chs=200x200&chl=${encodeURIComponent(url)}&choe=UTF-8&chld=L|2&chco=0a1538`;
  
  // Display QR code
  qrCodeDisplay.innerHTML = `<img src="${qrUrl}" alt="QR Code" style="max-width:100%;height:auto;border-radius:8px;">`;
  
  // Update URL display
  shareUrl.textContent = url;
  
  // Setup share buttons
  setupShareButtons(name, url);
  
  // Hide loading
  loadingSpinner.style.display = 'none';
  
  // Show modal
  shareModal.classList.add('show');
  
  showToast('Berhasil membuat kode QR!');
});

function setupShareButtons(name, url) {
  const message = `Selamat Tahun Baru 2026 dari ${name}! Sambut tahun baru dengan penuh harapan bersama Tuhan. Kirimkan ucapan khusus melalui link ini: ${url}`;
  const encodedMessage = encodeURIComponent(message);
  const encodedUrl = encodeURIComponent(url);
  
  // WhatsApp
  whatsappBtn.onclick = () => {
    window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
  };
  
  // Telegram
  telegramBtn.onclick = () => {
    window.open(`https://t.me/share/url?url=${encodedUrl}&text=${encodeURIComponent(`Selamat Tahun Baru 2026 dari ${name}!`)}`, '_blank');
  };
  
  // Facebook
  facebookBtn.onclick = () => {
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}&quote=${encodeURIComponent(`Selamat Tahun Baru 2026 dari ${name}`)}`, '_blank');
  };
  
  // Twitter
  twitterBtn.onclick = () => {
    const tweetText = `Selamat Tahun Baru 2026 dari ${name}! ${url}`;
    window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(tweetText)}`, '_blank');
  };
}

// Copy URL button
copyUrlBtn.addEventListener('click', async () => {
  if (!shareUrlValue) return;
  
  try {
    await navigator.clipboard.writeText(shareUrlValue);
    showToast('Link berhasil disalin!');
    
    // Change icon temporarily
    const icon = copyUrlBtn.querySelector('i');
    icon.className = 'fas fa-check';
    setTimeout(() => {
      icon.className = 'far fa-copy';
    }, 2000);
  } catch (err) {
    // Fallback for older browsers
    const textArea = document.createElement('textarea');
    textArea.value = shareUrlValue;
    document.body.appendChild(textArea);
    textArea.select();
    try {
      document.execCommand('copy');
      showToast('Link berhasil disalin!');
    } catch (copyErr) {
      showToast('Gagal menyalin link');
    }
    document.body.removeChild(textArea);
  }
});

// Close modal
closeModal.addEventListener('click', () => {
  shareModal.classList.remove('show');
});

// Close modal when clicking outside
shareModal.addEventListener('click', (e) => {
  if (e.target === shareModal) {
    shareModal.classList.remove('show');
  }
});

// Close modal with Escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && shareModal.classList.contains('show')) {
    shareModal.classList.remove('show');
  }
});

// ===== SAVE IMAGE =====
saveBtn.addEventListener('click', () => {
  const name = nameInput.value.trim();
  const fileName = name ? `tahun-baru-2026-${name.replace(/\s+/g, '-').toLowerCase()}.png` : 'selamat-tahun-baru-2026.png';
  
  // Hide share modal if open
  shareModal.classList.remove('show');
  
  // Show loading
  const originalText = saveBtn.textContent;
  saveBtn.textContent = '‚è≥ Menyimpan...';
  saveBtn.disabled = true;
  
  // Use html2canvas to capture the card
  html2canvas(document.getElementById('capture'), {
    scale: 2,
    useCORS: true,
    backgroundColor: null,
    logging: false,
    allowTaint: true,
    foreignObjectRendering: true
  }).then(canvas => {
    // Convert canvas to data URL
    const imageData = canvas.toDataURL('image/png');
    
    // Create download link
    const link = document.createElement('a');
    link.href = imageData;
    link.download = fileName;
    
    // Trigger download
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Restore button
    saveBtn.textContent = originalText;
    saveBtn.disabled = false;
    
    showToast('Gambar berhasil disimpan!');
  }).catch(error => {
    console.error('Error saving image:', error);
    saveBtn.textContent = originalText;
    saveBtn.disabled = false;
    showToast('Gagal menyimpan gambar', 3000);
  });
});

// ===== ENTER KEY SUPPORT =====
nameInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    shareBtn.click();
  }
});

// ===== INITIALIZATION =====
window.addEventListener('load', () => {
  console.log('Aplikasi Template Tahun Baru 2026 dimuat');
  
  // Initialize music
  initMusic();
  
  // Show welcome message
  setTimeout(() => {
    showToast('Selamat Tahun Baru 2026! üéâ‚ú® Semoga penuh berkat dan harapan baru!');
  }, 1000);
  
  // Initialize with default name if in locked mode
  if (app.classList.contains('locked')) {
    setTimeout(() => {
      generateSimpleQRCode(lockName);
    }, 500);
  }
  
  // Start rotating motivation texts
  setTimeout(rotateMotivation, 3000);
});

// ===== FIREWORKS EFFECT ON CLICK =====
document.addEventListener('click', (e) => {
  // Add extra fireworks on click
  for (let i = 0; i < 3; i++) {
    setTimeout(() => {
      createFirework();
    }, i * 100);
  }
  
  // Also handle first interaction for music
  handleFirstInteraction();
});
</script>
</body>
</html>
